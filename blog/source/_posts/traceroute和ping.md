---
title: traceroute和ping
date: 2019-08-08 10:39:38
tags: [网络,协议,面试]
---

​	在日常使用中我们常常会用到ping和traceroute，正好在面试中遇到了这个问题，特来整理一下，下面我们将对这两个协议的具体工作原理进行总结。

### Ping

​	Ping 是 **ICMP** 的一个重要应用，主要用来测试两台主机之间的连通性。Ping 的原理是**通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文**。**Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。**

##### ping完成的工作流程

> 构造ICMP数据包-->构造IP数据包-->构造以太网数据帧----物理传输到目标主机---->获取以太网数据帧-->解析出IP数据包-->解析出ICMP数据包-->发送回送应答报文

### Traceroute

​	Traceroute 是 **ICMP** 的另一个应用，**用来跟踪一个分组从源点到终点的路径**。有2种实现方案：基于UDP实现和基于ICMP实现。

#### 基于UDP的实现

​	在基于UDP的实现中，客户端发送的数据包是通过UDP协议来传输的，使用了一个大于30000的端口号，服务器在收到这个数据包的时候会返回一个端口不可达的ICMP错误信息，客户端**通过判断收到的错误信息是TTL超时还是端口不可达来判断数据包是否到达目标主机。**

1. 源主机向目的主机发送一连串的 IP 数据报（UDP报文）。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
2. 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文。
3. 不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文。
4. 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间。



如何获得路过的各个路由信息？

> 从1开始，每个TTL+1，到每个路由时TTL到0就会回复超时，这样客户端就可以得到每个路过的路由



#### 基于ICMP的实现

​	直接发送一个ICMP回显请求（echo request）数据包，服务器在收到回显请求的时候会向客户端发送一个ICMP回显应答（echo reply）数据包。流程与上面相似，只是最后**判断结束上为目标主机（而不是中间经过的主机或路由器）返回一个ICMP回显应答，则结束。**

